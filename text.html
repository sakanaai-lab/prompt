<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>テキストお題 - Aquarium</title>

  <link rel="stylesheet" href="style.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;500&display=swap"
    rel="stylesheet" />
</head>

<body>
  <div class="container">
    <header>
      <div class="icon-area-small">
        <div class="site-logo">Aquarium</div>
      </div>

      <a href="javascript:void(0)" class="url-copy-button" role="button" onclick="copyPageUrl(this)">
        このページのURLをコピー
      </a>

      <h1>テキストお題</h1>
      <p class="bio">タイトルをタップすると開くよ。</p>
      <a href="index.html" class="back-link">← 水槽に戻る</a>
    </header>
    <div class="bubble-divider">● ● ●</div>
    <main>
      <section class="prompt-list" id="promptList">
        <p id="loading">読み込み中…</p>
      </section>
    </main>

    <footer>
      <small>&copy; 2025 Sakana</small>
    </footer>
  </div>

  <!-- Page Top Button -->
  <button id="pageTopButton" class="page-top-button" onclick="scrollToTop()">↑</button>

  <script src="prompts-text.js"></script>

  <script>
    function renderPrompts(prompts) {
      const list = document.getElementById("promptList");
      const loading = document.getElementById("loading");
      if (loading) loading.remove();

      const frag = document.createDocumentFragment();

      // 逆順にして、最新のお題が一番上に表示されるようにする
      const reversed = [...prompts].reverse();

      for (const p of reversed) {
        const details = document.createElement("details");
        details.className = "prompt-box";

        const pid = p.id || ("prompt-" + Math.random().toString(36).slice(2));
        details.id = pid;

        const summary = document.createElement("summary");
        summary.textContent = p.title || "";

        const content = document.createElement("div");
        content.className = "prompt-content";

        // 説明文
        if (p.desc) {
          const descP = document.createElement("p");
          descP.innerHTML = String(p.desc).replaceAll("\n", "<br>");
          content.appendChild(descP);
        }

        // ボタンエリア（横並び）
        const actions = document.createElement("div");
        actions.className = "prompt-actions";

        // NOTEボタン（存在する時だけ）
        if (p.link) {
          const noteLink = document.createElement("a");
          noteLink.href = p.link;
          noteLink.target = "_blank";
          noteLink.rel = "noopener noreferrer";
          noteLink.className = "icon-btn";      // CSSで見た目を統一
          noteLink.title = "note記事を読む";
          noteLink.textContent = "NOTE";
          actions.appendChild(noteLink);
        }

        // URLコピーボタン
        const linkBtn = document.createElement("button");
        linkBtn.className = "icon-btn";         // NOTEと同じクラスにして揃える
        linkBtn.type = "button";
        linkBtn.textContent = "URL";
        linkBtn.onclick = () => copyPromptUrl(pid, linkBtn);
        actions.appendChild(linkBtn);

        content.appendChild(actions);

        // 本文（コピー欄）
        if (p.body) {
          const copy = document.createElement("div");
          copy.className = "copy-container";

          const ta = document.createElement("textarea");
          ta.readOnly = true;
          ta.textContent = p.body;

          const btn = document.createElement("button");
          btn.textContent = "コピーする";
          btn.onclick = function () { copyPrompt(btn); };

          copy.appendChild(ta);
          copy.appendChild(btn);
          content.appendChild(copy);
        }

        details.addEventListener("toggle", () => {
          if (details.open) history.replaceState(null, "", "#" + pid);
        });

        details.appendChild(summary);
        details.appendChild(content);
        frag.appendChild(details);
      }

      list.appendChild(frag);

      // ハッシュがあれば、そのお題を開く
      const hash = location.hash.replace("#", "");
      if (hash) {
        const target = document.getElementById(hash);
        if (target && target.tagName.toLowerCase() === "details") {
          target.open = true;
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }
    }

    function copyPrompt(button) {
      const textarea = button.previousElementSibling;
      textarea.select();
      textarea.setSelectionRange(0, 99999);

      const done = () => {
        const original = button.textContent;
        button.textContent = "コピーしました！";
        button.classList.add("copied");
        setTimeout(() => {
          button.textContent = original;
          button.classList.remove("copied");
        }, 2000);
      };

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textarea.value).then(done).catch(() => {
          document.execCommand("copy");
          done();
        });
      } else {
        document.execCommand("copy");
        done();
      }
    }

    function copyPromptUrl(promptId, button) {
      const url = location.origin + location.pathname + "#" + promptId;

      const done = () => {
        const original = button.textContent;
        button.textContent = "コピーした！";
        button.classList.add("copied");
        setTimeout(() => {
          button.textContent = original;
          button.classList.remove("copied");
        }, 2000);
      };

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(done).catch(() => {
          document.execCommand("copy");
          done();
        });
      } else {
        const temp = document.createElement("textarea");
        temp.value = url;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand("copy");
        document.body.removeChild(temp);
        done();
      }
    }

    function copyPageUrl(button) {
      const url = location.href;

      const done = () => {
        const original = button.textContent;
        button.textContent = "コピーしました！";
        button.classList.add("copied");
        setTimeout(() => {
          button.textContent = original;
          button.classList.remove("copied");
        }, 2000);
      };

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(done).catch(() => {
          document.execCommand("copy");
          done();
        });
      } else {
        const temp = document.createElement("textarea");
        temp.value = url;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand("copy");
        document.body.removeChild(temp);
        done();
      }
    }

    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // ページトップボタンの表示/非表示
    window.addEventListener('scroll', () => {
      const button = document.getElementById('pageTopButton');
      if (window.scrollY > 300) {
        button.classList.add('visible');
      } else {
        button.classList.remove('visible');
      }
    });

    renderPrompts(window.PROMPTS_TEXT || []);
  </script>
</body>

</html>