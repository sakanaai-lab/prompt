<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>一言お題 - Aquarium</title>

    <link rel="stylesheet" href="style.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;500&display=swap"
        rel="stylesheet" />
</head>

<body>
    <div class="container">
        <header>
            <div class="icon-area-small">
                <div class="site-logo">Aquarium</div>
            </div>

            <a href="javascript:void(0)" class="url-copy-button" role="button" onclick="copyPageUrl(this)">
                このページのURLをコピー
            </a>

            <h1>一言お題</h1>
            <p class="bio">気になったらボタンで即コピー。</p>
            <a href="index.html" class="back-link">← 水槽に戻る</a>
        </header>
        <div class="bubble-divider">● ● ●</div>
        <main>
            <section class="oneword-list" id="onewordList">
                <p id="loading">読み込み中…</p>
            </section>
        </main>

        <footer>
            <small>&copy; 2025 Sakana</small>
        </footer>
    </div>

    <!-- Page Top Button -->
    <button id="pageTopButton" class="page-top-button" onclick="scrollToTop()">↑</button>

    <script>
        // Google Sheets API URL
        const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbzrTXlQRNCr5swDN_gUxm6Tpx4jR-lgjBQqRmD24vlG3Wuollmhg37pcTAKm4RImbpW/exec';

        async function loadOnewords() {
            try {
                const response = await fetch(SHEETS_API_URL);
                const data = await response.json();
                // 逆順にして、最新のお題が一番上に表示されるようにする
                const reversed = data.reverse();
                renderOnewords(reversed);
            } catch (error) {
                console.error('データの読み込みに失敗しました:', error);
                document.getElementById('loading').textContent = '読み込みに失敗しました。';
            }
        }

        function renderOnewords(onewords) {
            const list = document.getElementById("onewordList");
            const loading = document.getElementById("loading");
            if (loading) loading.remove();

            const frag = document.createDocumentFragment();

            for (let i = 0; i < onewords.length; i++) {
                const item = onewords[i];
                const card = document.createElement("div");
                card.className = "oneword-card";

                // お題のIDを生成（インデックスベース）
                const promptId = `oneword-${i}`;
                card.id = promptId;

                const text = document.createElement("div");
                text.className = "oneword-text";
                text.textContent = item.text;

                // ボタンエリア
                const buttonArea = document.createElement("div");
                buttonArea.className = "oneword-button-area";

                // コピーボタン
                const copyBtn = document.createElement("button");
                copyBtn.className = "oneword-copy-btn";
                copyBtn.textContent = "コピー";
                copyBtn.onclick = () => copyOneword(item.text, copyBtn);

                // URLコピーボタン
                const urlBtn = document.createElement("button");
                urlBtn.className = "oneword-copy-btn oneword-url-btn";
                urlBtn.textContent = "URL";
                urlBtn.onclick = () => copyOnewordUrl(promptId, urlBtn);

                buttonArea.appendChild(copyBtn);
                buttonArea.appendChild(urlBtn);

                card.appendChild(text);
                card.appendChild(buttonArea);
                frag.appendChild(card);
            }

            list.appendChild(frag);

            // ハッシュがあれば、そのお題にスクロール
            const hash = location.hash.replace("#", "");
            if (hash) {
                const target = document.getElementById(hash);
                if (target) {
                    setTimeout(() => {
                        target.scrollIntoView({ behavior: "smooth", block: "center" });
                        target.style.backgroundColor = "#e8f4f8";
                        setTimeout(() => {
                            target.style.backgroundColor = "";
                        }, 2000);
                    }, 100);
                }
            }
        }

        function copyOneword(text, button) {
            const done = () => {
                const original = button.textContent;
                button.textContent = "コピーした！";
                button.classList.add("copied");
                setTimeout(() => {
                    button.textContent = original;
                    button.classList.remove("copied");
                }, 2000);
            };

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(done).catch(() => {
                    const temp = document.createElement("textarea");
                    temp.value = text;
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand("copy");
                    document.body.removeChild(temp);
                    done();
                });
            } else {
                const temp = document.createElement("textarea");
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand("copy");
                document.body.removeChild(temp);
                done();
            }
        }

        function copyOnewordUrl(promptId, button) {
            const url = location.origin + location.pathname + "#" + promptId;

            const done = () => {
                const original = button.textContent;
                button.textContent = "コピーした！";
                button.classList.add("copied");
                setTimeout(() => {
                    button.textContent = original;
                    button.classList.remove("copied");
                }, 2000);
            };

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(done).catch(() => {
                    const temp = document.createElement("textarea");
                    temp.value = url;
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand("copy");
                    document.body.removeChild(temp);
                    done();
                });
            } else {
                const temp = document.createElement("textarea");
                temp.value = url;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand("copy");
                document.body.removeChild(temp);
                done();
            }
        }

        function copyPageUrl(button) {
            const url = location.href;

            const done = () => {
                const original = button.textContent;
                button.textContent = "コピーしました！";
                button.classList.add("copied");
                setTimeout(() => {
                    button.textContent = original;
                    button.classList.remove("copied");
                }, 2000);
            };

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(done).catch(() => {
                    document.execCommand("copy");
                    done();
                });
            } else {
                const temp = document.createElement("textarea");
                temp.value = url;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand("copy");
                document.body.removeChild(temp);
                done();
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        window.addEventListener('scroll', () => {
            const button = document.getElementById('pageTopButton');
            if (window.scrollY > 300) {
                button.classList.add('visible');
            } else {
                button.classList.remove('visible');
            }
        });

        // ページ読み込み時にスプレッドシートからデータを取得
        loadOnewords();
    </script>
</body>

</html>